<div
  class="product-recommendations"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ section.settings.limit }}"
>
  {%- if recommendations.performed and recommendations.products_count > 0 -%}
    <h2 style="color:{{ section.settings.colorTitle }}">{{ section.settings.heading | escape }}</h2>
    <h3 style="color:{{ section.settings.colorDesc }}">{{ section.settings.description | escape }}</h3>

    <ul>
      {%- for product in recommendations.products -%}
        <li class="product">
          <a href="{{ product.url }}">
            <img
              class="product__img"
              src="{{ product.featured_image | img_url: '300x300' }}"
              alt="{{ product.featured_image.alt }}"
            />

            <p class="product__title">{{ product.title }}</p>
            <p class="product__price">{{ product.price | money}}</p>
          </a>
        </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}
</div>

{% javascript %}
  const handleIntersection = (entries, observer) => {
    if (!entries[0].isIntersecting) return;

    observer.unobserve(productRecommendationsSection);

    const url = productRecommendationsSection.dataset.url;

    fetch(url)
      .then(response => response.text())
      .then(text => {
        const html = document.createElement('div');
        html.innerHTML = text;
        const recommendations = html.querySelector('.product-recommendations');

        if (recommendations && recommendations.innerHTML.trim().length) {
          productRecommendationsSection.innerHTML = recommendations.innerHTML;
        }
      })
      .catch(e => {
        console.error(e);
      });
  };

  const productRecommendationsSection = document.querySelector('.product-recommendations');
  const observer = new IntersectionObserver(handleIntersection, {rootMargin: '0px 0px 200px 0px'});

  observer.observe(productRecommendationsSection);
{% endjavascript %}

{% schema %}
  {
    "name": "Product recommendations",
    "settings": [
        {
        "type": "checkbox",
        "id": "show_product_recommendations",
        "label": "Show dynamic recommendations",
        "default": true
        },
 		{
        "type": "text",
        "id": "heading",
        "label": "Show dynamic title",
        "default": "You may also like"
        },
 		{
        "type": "text",
        "id": "description",
        "label": "Show dynamic description",
        "default": "You may also like description"
        },
 		{
        "type": "text",
        "id": "colorTitle",
        "label": "color title",
         "default": "red"
        },
 		{
        "type": "text",
        "id": "colorDesc",
        "label": "color description",
        "default": "green"
        },
 		{
        "type": "number",
        "id": "limit",
        "label": "limit",
        "default": 1
        }

    ]
  }
{% endschema %}
